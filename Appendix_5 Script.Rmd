---
title: 'Appendix'
author: 'Aaron'
date: '`r Sys.Date()`'
output:
  html_document:
    theme: flatly
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(
   error = function(x, options) {
     paste('\n\n<div class="alert alert-danger">',
           gsub('##', '\n', gsub('^##\ Error', '**Error**', x)),
           '</div>', sep = '\n')
   },
   warning = function(x, options) {
     paste('\n\n<div class="alert alert-warning">',
           gsub('##', '\n', gsub('^##\ Warning:', '**Warning**', x)),
           '</div>', sep = '\n')
   },
   message = function(x, options) {
     paste('\n\n<div class="alert alert-info">',
           gsub('##', '\n', x),
           '</div>', sep = '\n')
   }
)
```

# Data preview

| 1      | 2       | 3      | 4     | 5      | 6            | 7          |
| ------ | ------- | ------ | ----- | ------ | ------------ | ---------- |
| S53A   | 1386 km | 7038.6 | 11 dB | 20 wpm | 0837z 21 Dec | horizontal |
| SE5E   | 1380 km | 7038.6 | 14 dB | 21 wpm | 0837z 21 Dec | horizontal |
| DL8LAS | 799 km  | 7038.6 | 6 dB  | 21 wpm | 0838z 21 Dec | horizontal |
| DM7EE  | 828 km  | 7038.6 | 11 dB | 21 wpm | 0838z 21 Dec | horizontal |

The meaning of each column of indicators can be determined through Google search and speculation

1. ID column: the sign of the receiving station

2. Distance column: the distance between your location and receiving station

3. Frequency column:

4. SNR column: the signal to noise ratio

5. Speed column: Words per minute

6. Time column: The class of column is a character too, and the format is “%H%M %d %b”

7. Type column: Antenna orientation

Copy data from ODS files to a new XLSX file, and read the file through the following code:

## loading packages and reading data

```{r message=FALSE, warning=FALSE}
# loading packages --------------------------------------------------------

## Cleaning Data Packages
library(tidyverse)
## Reading XLSX file Packages
library(openxlsx)
## Clean Date
library(lubridate)

library(car)
library(ggpubr)
library(rstatix)

## Set Date format zone
Sys.setlocale(locale = 'EN')

# reading data ------------------------------------------------------------

DataRaw <- read.xlsx('./Appendix_1 Raw Data.xlsx')
## The type of DataRaw
str(DataRaw)
## The hand of DataRaw
head(DataRaw)
```

## The problem of raw data

The raw data cannot meet the requirements. By running the code, you can find some problems

1. ID column: Spaces in the text

2. Distance column: Contains units

3. Frequency column: The class of column is the character, not the number or integer

4. SNR column: contains units

5. Speed column: Also contains units

6. Time column: The class of column is a character too, and the format is “%H%M %d %b”

7. Type column: Sees OK, but this column have 3 elements: `"horizontal"     "magloop"        "horizontal qro"`

# Data cleaning

```{r}
## Time extract to year, month, day and Periods (0-6, 7-11, 12-15, 18-24).
DataClean <- DataRaw |>
  mutate(ID = str_remove_all(ID, "\\s+"),
         Distance = as.numeric(str_remove_all(Distance, "\\D")),
         Frequency = as.numeric(Frequency),
         SNR = as.numeric(str_remove_all(SNR, "\\D")),
         ## horizontal qro is a type of Antenna orientation
         # Type = str_remove_all(Type, " qro"),
         Speed = as.numeric(str_remove_all(Speed, "\\D"))) |>
  mutate(Time = str_remove(Time, 'z'),
         Time = paste(substr(Time, 1, 2), substr(Time, 3, nchar(Time))),
         Time = paste(Time, year), ## Suppose all data was collected in 2022
         Time = as.POSIXct(Time, format = "%H %M %d %b %Y")) |>
  ## Time extract to year, month, day and Periods, Facilitate subsequent analysis of the impact of time on SNR
  mutate(month = month(Time),
         day = day(Time),
         hour = hour(Time),
         periods = if_else(hour >= 18, "Evening",
                      if_else(hour >= 12, "Afternoon",
                             if_else(hour >= 6, "Morning", "Early morning"))),
         season = if_else(month >= 12 | month <= 2, "Winter",
                          if_else(month >= 6 & month <= 8, "Summer",
                                  if_else(month >= 9 & month <= 11, "Autumn", "Spring"))
                          ),
         season = factor(season,
                         levels = c("Summer", "Winter")))
DataClean$Type[DataClean$Type == "horizontal"] <- "Horizontal Antenna"
DataClean$Type[DataClean$Type == "horizontal QRO"] <- "Horizontal Antenna (QRO)"
DataClean$Type[DataClean$Type == "horizontal qro"] <- "Horizontal Antenna (QRO)"
DataClean$Type[DataClean$Type == "magloop"] <- "Magnetic Loop Antenna"

head(DataClean)
```

## Check all columns of data

```{r}
# table(DataClean$ID)
ValueCheckID <- DataClean$ID |>
  grepl(pattern = "[^A-Za-z0-9]")

if (any(ValueCheckID)) {
  warning(paste("ID contains unexpected values, please check carefully!"))
  print(DataClean[which(ValueCheckID),])
}
```

```{r}
DataClean[DataClean$ID == "https://reversebeacon.net/qrz/rbn/MM0ZBH", "ID"] <- "MM0ZBH"
DataClean$ID <- str_remove_all(DataClean$ID, "-.*")
write.csv(unique(DataClean$ID), file = './station.csv', quote = F)

DataClean[DataClean$Type == "horizontal qro", "Type"] <- "horizontal QRO"
```

```{r message=FALSE, warning=FALSE}
summary(DataClean$Distance)
summary(DataClean$Frequency)
summary(DataClean$Power)
summary(DataClean$Speed)
summary(DataClean$Type)
table(DataClean$Type)
summary(DataClean$Time)
```

## Location

```{r message=FALSE, warning=FALSE}
library(geosphere)
library(leaflet)
```

setting the location of London, and calculate the oriention of station.

```{r fig.width=8}
DataLocation <- read.xlsx('./Appendix_3 Update Station Location.xlsx')
LondonLocation <- c(51.5072, -0.1276)

DataLocation$Direction1[DataLocation$Longitude < LondonLocation[2]] <- "W"
DataLocation$Direction1[DataLocation$Longitude > LondonLocation[2]] <- "E"
DataLocation$Direction2[DataLocation$Latitude < LondonLocation[1]] <- "S"
DataLocation$Direction2[DataLocation$Latitude > LondonLocation[1]] <- "N"

# DataLocation <- DataLocation[,c("x", "Direction1", "Direction2")]

DataLocation$Direction2[DataLocation$Direction2 == "N"] <- "North"
DataLocation$Direction2[DataLocation$Direction2 == "S"] <- "South"
DataLocation$Direction1[DataLocation$Direction1 == "E"] <- "East"
DataLocation$Direction1[DataLocation$Direction1 == "W"] <- "West"


DataLocation <- DataLocation |>
  mutate(Location = paste(Direction2, Direction1, sep = '-'))

DataClean <- DataClean |>
  left_join(DataLocation, by = c(ID = 'x'))

DataMap <- DataClean |>
  group_by(ID, Latitude, Longitude) |>
  count() |>
  mutate(
    color = cut(n,
                breaks = c(0, 10, 30, 100),
                labels = c('green', 'navy', 'red')),
    radius = cut(n,
                 breaks = c(0, 10, 30, 100),
                 labels = c(3, 7, 10))
  )

# leaflet() |>
#   addTiles() |>
#   addMarkers(data = DataLocation,
#              lat = ~Latitude,
#              lng = ~Longitude) |>
#   addCircleMarkers(lat = LondonLocation[1],
#                    lng = LondonLocation[2],
#                    color = "red",
#                    radius = 8)
leaflet() |>
  addTiles() |>
  addCircleMarkers(data = DataMap,
                   lng = ~Longitude,
                   lat = ~Latitude,
                   radius = ~as.numeric(as.character(radius)),
                   color = ~color,
                   stroke = F,
                   fillOpacity = 0.8) |>
  addMarkers(lat = LondonLocation[1],
             lng = LondonLocation[2])
```

```{r echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
library(arsenal)
DataStation <- DataClean |>
  select(ID, Location, Distance) |>
  unique() |>
  mutate(DistanceGroup = cut(Distance,
                             breaks = c(0, 500, 1000, 1300, 3000, 10000)))

table_labels <- list(Location = "Oriention",
                     Distance = "Distance, km",
                     DistanceGroup = "Distance Group, km",
                     season = "Season")
table_m <- tableby(Location ~ Distance + DistanceGroup,
                   data = DataStation)

summary(table_m,
        labelTranslations = table_labels,
        title = "Table 2.",
        numeric.stats = c('median', 'q1q3'),
        digits=0, digits.p=2, digits.pct=1,
        pfootnote=TRUE)
```

Most stations are located in the European region at the east of London.

# Pre-analysis

```{r echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
DataTable <- DataClean |>
  select(Type, Location, Distance, Frequency, Speed, SNR, periods, season) |>
  mutate(DistanceGroup = cut(Distance,
                             breaks = c(0, 500, 1000, 1300, 3000, 10000)))
table_labels <- list(Location = "Oriention",
                     Distance = "Distance, km",
                     DistanceGroup = "Distance Group, km",
                     Frequency = 'Frequency, kHz',
                     Speed = "Speed, words per minute",
                     SNR = "SNR, dB",
                     periods = "Periods of Day",
                     season = "Season",
                     Type = "Type of Antenna")
table_m <- tableby(Type ~ Location + Distance + DistanceGroup + Speed + SNR + periods + season,
                   data = DataTable,
                   test=FALSE)

summary(table_m,
        labelTranslations = table_labels,
        title = "Table 1.",
        numeric.stats = c('median', 'q1q3'),
        digits=0, digits.p=2, digits.pct=1,
        pfootnote=TRUE)
```

```{r message=FALSE, warning=FALSE}
library(wordcloud)
library(patchwork)
library(viridis)
library(GGally)
```

### Distribution of calls signs

```{r fig.height=8, fig.width=8}
DataSumAll <- DataClean |>
  mutate(Location = paste(Direction2, Direction1, sep = '-')) |>
  group_by(ID, Location) |>
  count() |>
  as.data.frame() |>
  arrange(desc(n)) |>
  mutate(ID = factor(ID, levels = ID))

DataSum <- DataClean |>
  mutate(Location = paste(Direction2, Direction1,  sep = '-')) |>
  group_by(ID, Type, Location) |>
  count() |>
  as.data.frame() |>
  arrange(desc(n)) |>
 mutate(ID = factor(ID, levels = DataSumAll$ID))

head(DataSumAll)
```

```{r fig.height=14, fig.width=8, message=FALSE, warning=FALSE}
labeltype <- c(
  `Horizontal Antenna` = "Horizontal\nAntenna",
                                 `Magnetic Loop Antenna` = "Magnetic Loop\nAntenna",
                                 `Horizontal Antenna (QRO)` = "Horizontal\nAntenna (QRO)"
)
fig1 <- ggplot(data = DataSumAll) +
  geom_col(mapping = aes(x = ID,
                         y = n),
           fill = 'grey50')+
  scale_fill_viridis_d()+
  coord_flip()+
  labs(title = "A:",
       y = 'Count',
       x = NULL)

fig3 <- ggplot(data = DataSum) +
  geom_col(mapping = aes(x = ID,
                         y = n,
                         fill = Type))+
  scale_fill_viridis_d()+
  coord_flip()+
  facet_grid(.~Type,
             labeller = labeller(Type = labeltype)
             )+
  theme(legend.position = 'none')+
  labs(title = "B:",
       y = 'Count',
       x = NULL)

DataSumAll <- DataSum |>
  select(ID, Type, n) |>
  pivot_wider(names_from = Type,
              values_from = n) |>
  right_join(DataSumAll) |>
  arrange(desc(n))

write.xlsx(DataSumAll,
           file = './Appendix_7 Shortwave Antenna Stations and Sessions Distribution.xlsx')

fig1 + fig3
```

### Distribution of time

```{r}
DataClean <- DataClean |>
  mutate(md = paste(month, day, sep = "-"))

write.xlsx(DataClean,
           "./Appendix_4 Cleaned Data.xlsx")

DataClean |>
  group_by(season, hour, Type) |>
  count() |>
  pivot_wider(names_from = Type,
              values_from = n,
              values_fill = 0) |>
  mutate(total = `Horizontal Antenna` + `Magnetic Loop Antenna`  +  `Horizontal Antenna (QRO)`) |>
  print(n = 50)


ggplot(DataClean,
       mapping = aes(x = hour,
                     fill = Type)) +
  geom_histogram(binwidth = 1,
                 color = "black") +
  facet_grid(season ~ .,
             scales = "free_x") +
  scale_y_continuous(limits = c(0, 170),
                     expand = c(0, 0))+
  scale_x_continuous(breaks = 5:22) +
  scale_fill_viridis_d()+
  theme_bw() +
  theme(legend.position = 'top') +
  labs(x = "Hour",
       y = "Frequency")
```

### Distribution of distance

```{r fig.height=4, fig.width=8}

DataSum <- DataClean |>
  mutate(DistanceGroup = cut(Distance,
                             breaks = c(0, 500, 1000, 1300, 3000, 10000)))

fig1 <- ggplot(data = DataClean,
       mapping = aes(x = Distance,
                     fill= Type))+
  geom_histogram(binwidth = 200)+
  scale_fill_viridis_d()+
  scale_y_continuous(expand = expansion(mult = c(0, 0.2)),
                     limits = c(0, NA))+
  theme_bw()+
  theme(legend.position = c(0.95, 0.95),
        legend.justification = c(1, 1))+
  labs(x = "Distance (km)",
       y = "Count",
       title = 'A:')

fig2 <- ggplot(DataSum, aes(x = DistanceGroup,
                    fill = Type)) +
  geom_bar(position = "fill", width = 1)+
  scale_fill_viridis_d()+
  theme_bw()+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90))+
  labs(x = "Distance (km)",
       y = "Percentage",
       title = 'B:')

fig1 + fig2

```

```{r}
DataClean$DistanceToLondon <- distVincentySphere(
  cbind(DataClean$Longitude, DataClean$Latitude),
  cbind(LondonLocation[2], LondonLocation[1])
)/1000

DataClean$Diff <- DataClean$DistanceToLondon - DataClean$Distance

ggplot(data = DataClean,
       mapping = aes(x = Diff,
                     fill= Type))+
  geom_histogram(binwidth = 50)+
  scale_fill_viridis_d()+
  scale_y_continuous(expand = expansion(mult = c(0, 0.2)),
                     limits = c(0, NA))+
  theme_bw()+
  theme(legend.position = c(0.05, 0.95),
        legend.justification = c(0, 1))+
  labs(x = "Distance (km)",
       y = "Count",
       title = 'A:')

quantile(DataClean$Diff, na.rm = T)
t.test(DataClean$Diff)
```

Contains one out bar, VR2FUN located on HongKong, China.

Longitude and latitude of this station maybe error.

```{r}
ValueOut <- DataClean |>
  filter(Diff < -150 | Diff > 150) |>
  group_by(ID, Diff) |>
  count() |>
  arrange(Diff)
print(ValueOut)
```

### Distribution of speed

```{r}

fig1 <- ggplot(data = DataClean,
       mapping = aes(x = Speed,
                     fill= Type))+
  geom_histogram(binwidth = 1)+
  scale_fill_viridis_d()+
  scale_y_continuous(expand = expansion(mult = c(0, 0.2)),
                     limits = c(0, NA))+
  theme_bw()+
  theme(legend.position = c(0.95, 0.95),
        legend.justification = c(1, 1))+
  labs(x = "Speed (WPM, words per minute)",
       y = "Count",
       title = 'A:')

fig2 <- ggplot(DataSum,
               mapping = aes(x = Speed,
                             fill = Type)) +
  geom_bar(position = "fill", width = 1)+
  scale_fill_viridis_d()+
  theme_bw()+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90))+
  labs(x = "Speed (WPM, words per minute)",
       y = "Percentage",
       title = 'B:')

fig1 + fig2

```

### Distribution of SNR (Signal-to-Noise Ratio)

```{r fig.height=4, fig.width=8}
fig1 <- ggplot(data = DataClean)+
  geom_density(mapping = aes(x = SNR,
                             fill = Type),
               alpha = 0.5)+
  scale_color_viridis_d()+
  scale_y_continuous(expand = expansion(mult = c(0, 0.2)),
                     limits = c(0, NA))+
  theme_bw()+
  theme(legend.position = c(0.95, 0.95),
        legend.justification = c(1, 1))+
  labs(x = "SNR (Signal-to-Noise Ratio)",
       y = "Density",
       title = 'A:')

fig2 <- ggplot(DataClean, aes(x = Type, y = SNR, fill = Type)) +
  geom_boxplot(color = "black")+
  scale_x_discrete(labels = labeltype)+
  theme(legend.position = 'none')+
  labs(title = 'B:',
       y = "SNR (Signal-to-Noise Ratio)",
       x = NULL)

fig1 + fig2

DataSummary <- DataClean |>
  group_by(Type) |>
  summarise(SNR_Mean = mean(SNR),
            SNR_Median = median(SNR),
            IQR = paste(quantile(SNR, 0.25), quantile(SNR, 0.75), sep = '-'))
print(DataSummary)
```

```{r}
ggplot(DataClean, aes(x = Type, y = SNR, fill = Type)) +
  geom_boxplot(color = "black")+
  facet_wrap(.~Location,
             ncol = 2)+
  scale_x_discrete(labels = labeltype)+
  theme(legend.position = 'none')+
  labs(y = "SNR (Signal-to-Noise Ratio)",
       x = NULL)
```

```{r}
DataClean |>
  group_by(Location, Type) |>
  summarise(mean = mean(SNR),
            SD = sd(SNR),
            .groups = 'drop')
```

# Statistical analysis

## Relation between values

```{r fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
## Dummy variable
DataClean <- DataClean |>
  mutate(TypeQro = if_else(Type == 'Horizontal Antenna (QRO)', 1, 0),
         TypeMag = if_else(Type == 'Magnetic Loop Antenna', 1, 0),
         DistanceGroup = cut(Distance,
                             breaks = c(0, 500, 1000, 1300, 3000, 10000)))

ggpairs(data = DataClean[,c("SNR", "Distance", "Location", "hour", "season", "Type")],
        mapping = aes(color = Type),
        columnLabels = c("SNR", "Distance, km", "Orientation", "Hour", "Season", "Setup"),
        alpha = 0.5)
```

No significant correlation was found between the variables.

```{r fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
DataClean <- DataClean |>
  mutate(stage = if_else(hour < 7 | hour >20,
                         "Dark", "Light"),
         FrequencyGroup = if_else(Frequency < 10000,
                                  "40m band",
                                  "20m band"))
fig1 <- ggplot(data = DataClean) +
  geom_boxplot(mapping = aes(x = Location,
                             y = SNR,
                             group = Location,
                             color = Type))+
  geom_jitter(mapping = aes(x = Location,
                          y = SNR,
                          group = Location,
                          color = Type),
               alpha = 0.2)+
  geom_line(mapping = aes(x = Location,
                          y = SNR,
                          group = Type),
            stat = "summary",
            fun.data = function(x) {
              y <- median(x)
              data.frame(y = y)
            },
            size = 1) +
  facet_grid(Type~.,
             labeller = labeller(Type = labeltype)) +
  labs(x = NULL,
       title = "A")

fig2 <- ggplot(data = DataClean) +
  geom_boxplot(mapping = aes(x = DistanceGroup,
                             y = SNR,
                             group = DistanceGroup,
                             color = Type))+
  geom_jitter(mapping = aes(x = DistanceGroup,
                          y = SNR,
                          group = DistanceGroup,
                          color = Type),
               alpha = 0.2)+
  geom_line(mapping = aes(x = DistanceGroup,
                          y = SNR,
                          group = Type),
            stat = "summary",
            fun.data = function(x) {
              y <- median(x)
              data.frame(y = y)
            },
            size = 1) +
  facet_grid(Type~.,
             labeller = labeller(Type = labeltype)) +
  labs(x = NULL,
       title = "B",
       y = NULL)

fig3 <- ggplot(data = DataClean) +
  geom_boxplot(mapping = aes(x = paste(season, stage),
                             y = SNR,
                             group = paste(season, stage),
                             color = Type))+
  geom_jitter(mapping = aes(x = paste(season, stage),
                          y = SNR,
                          group = paste(season, stage),
                          color = Type),
               alpha = 0.2)+
  geom_line(mapping = aes(x = paste(season, stage),
                          y = SNR,
                          group = Type),
            stat = "summary",
            fun.data = function(x) {
              y <- median(x)
              data.frame(y = y)
            },
            size = 1) +
  facet_grid(Type~FrequencyGroup,
             scales = "free_x",
             labeller = labeller(Type = labeltype)) +
  labs(x = NULL,
       title = "C")


(fig1 + fig2) / fig3 &
  theme(legend.position = 'none')
```

```{r}
DataClean |>
  group_by(Type, Location) |>
  summarize(median = median(SNR),
            Q1 = quantile(SNR, 0.25),
            Q3 = quantile(SNR, 0.75))

DataClean |>
  group_by(Type, DistanceGroup) |>
  summarize(median = median(SNR),
            Q1 = quantile(SNR, 0.25),
            Q3 = quantile(SNR, 0.75))

DataClean |>
  group_by(FrequencyGroup, Type, season_stage = paste(season, stage)) |>
  summarize(median = median(SNR),
            Q1 = quantile(SNR, 0.25),
            Q3 = quantile(SNR, 0.75))

```

## Comparsion analysis of varied antenna orientation

### Check the distribution of data

```{r}
shapiro.test(DataClean$SNR[DataClean$Type == "Horizontal Antenna"])
shapiro.test(DataClean$SNR[DataClean$Type == "Magnetic Loop Antenna"])
shapiro.test(DataClean$SNR[DataClean$Type == "Horizontal Antenna (QRO)"])

leveneTest(SNR ~ Type,
           data = DataClean)
```

Meets the requirements of normality and homogeneity of variance

## Unadjust

```{r}
DataClean$Type <- as.factor(DataClean$Type)
anova_test(SNR ~ Type + FrequencyGroup,
           data = DataClean)

DataCopy <- DataClean |>
  mutate(Type = as.character(Type)) |>
  select(Type, SNR, FrequencyGroup)

stat.test.higher <- t_test(SNR ~ Type,
                    data = DataCopy[DataCopy$FrequencyGroup == "20m band",],
                    comparisons = list(c("Horizontal Antenna", "Horizontal Antenna (QRO)"),
                                       c("Horizontal Antenna", "Magnetic Loop Antenna")),
                    p.adjust.method = "none") |>
  add_significance() |>
  add_xy_position(x = "Type")

stat.test.lower <- t_test(SNR ~ Type,
                    data = DataCopy[DataCopy$FrequencyGroup == "40m band",],
                    comparisons = list(c("Horizontal Antenna", "Horizontal Antenna (QRO)"),
                                       c("Horizontal Antenna", "Magnetic Loop Antenna")),
                    p.adjust.method = "none") |>
  add_significance() |>
  add_xy_position(x = "Type")

stat.test.higher$p <- "p < 0.001"
stat.test.lower$p <- c("p < 0.001", "p = 0.042")
stat.test.higher$xmax <- 2
stat.test.lower$xmax <- 2
stat.test.higher$y.position <- stat.test.higher$y.position - 10
stat.test.lower$y.position <- stat.test.lower$y.position - 10

stat.test.higher
stat.test.lower

mean(DataClean$SNR[DataClean$Type == "Horizontal Antenna" & DataClean$FrequencyGroup == "40m band"])
mean(DataClean$SNR[DataClean$Type == "Horizontal Antenna" & DataClean$FrequencyGroup == "20m band"])
mean(DataClean$SNR[DataClean$Type == "Magnetic Loop Antenna"& DataClean$FrequencyGroup == "40m band"] )
mean(DataClean$SNR[DataClean$Type == "Magnetic Loop Antenna"& DataClean$FrequencyGroup == "20m band"] )
mean(DataClean$SNR[DataClean$Type == "Horizontal Antenna (QRO)" & DataClean$FrequencyGroup == "40m band"])
mean(DataClean$SNR[DataClean$Type == "Horizontal Antenna (QRO)" & DataClean$FrequencyGroup == "20m band"])

t.test(DataClean$SNR[DataClean$Location == "North-West" & DataClean$Type == "Horizontal Antenna (QRO)"],
       DataClean$SNR[DataClean$Location == "North-West" & DataClean$Type == "Horizontal Antenna"])
```

## Paired sample

### Horizontal Antenna and Magnetic Loop Antenna

```{r fig.height=6, fig.width=8}
DataSub <- DataClean |>
  arrange(ID, Time) |>
  dplyr::filter(Type %in% c("Horizontal Antenna", "Magnetic Loop Antenna"))

DataSub$pair <- NA

time_window <- 2

pair_counter <- 1
for (i in 2:nrow(DataSub)) {
  ## Same ID, Samilar time and varied type
  if (DataSub$ID[i] == DataSub$ID[i - 1] &&
      difftime(DataSub$Time[i], DataSub$Time[i - 1], units = "hours") <= time_window &&
      DataSub$Type[i] != DataSub$Type[i - 1]) {
    DataSub$pair[i] <- pair_counter
    DataSub$pair[i - 1] <- pair_counter
    pair_counter <- pair_counter + 1
  }
}

fig1 <- ggboxplot(data = DataSub[DataSub$FrequencyGroup == "20m band",],
                 x = "Type",
                 y = "SNR",
                 color = "Type",
                 palette = 'Viridis',
                 add = 'jitter',
                 ggtheme = theme_bw(),
                 legend='none',
                 xlab = "",
                 ylab = 'SNR',
                 title = 'A') +
  stat_pvalue_manual(stat.test.higher[2,],
                     label = "p",
                     tip.length = 0.01)+
  scale_x_discrete(breaks = NULL)
fig2 <- ggboxplot(data = DataSub[DataSub$FrequencyGroup == "40m band",],
                 x = "Type",
                 y = "SNR",
                 color = "Type",
                 palette = 'Viridis',
                 add = 'jitter',
                 ggtheme = theme_bw(),
                 legend='none',
                 xlab = "",
                 ylab = 'SNR',
                 title = 'B') +
  stat_pvalue_manual(stat.test.lower[2,],
                     label = "p",
                     tip.length = 0.01)+
  scale_x_discrete(breaks = NULL)

DataSumFre <- DataClean |>
  group_by(hour, Type, FrequencyGroup, season) |>
  summarize(median_SNR = median(SNR),
            lower_IQR = quantile(SNR, 0.25),
            upper_IQR = quantile(SNR, 0.75),
            .groups = 'drop')

fig3 <- ggplot(dplyr::filter(DataClean,
                             Type %in% c("Horizontal Antenna", "Magnetic Loop Antenna") &
                               FrequencyGroup == "20m band"),
               mapping = aes(x = hour, y = SNR)) +
  geom_smooth(mapping = aes(color = Type), size = 1)+
  scale_x_continuous(limits = c(6, 22))+
  facet_grid(season ~ ., scales = "free_x") +
  theme_bw() +
  theme(legend.position = 'right') +
  labs(x = "Hour", y = "SNR", color = "Type", title = "C")
fig4 <- ggplot(dplyr::filter(DataClean,
                             Type %in% c("Horizontal Antenna", "Magnetic Loop Antenna") &
                               FrequencyGroup == "40m band"),
               mapping = aes(x = hour, y = SNR)) +
  geom_smooth(mapping = aes(color = Type), size = 1)+
  scale_x_continuous(limits = c(6, 22))+
  facet_grid(season ~ ., scales = "free_x") +
  theme_bw() +
  theme(legend.position = 'right') +
  labs(x = "Hour", y = "SNR", color = "Type", title = "D")

fig1 + fig3 + fig2 + fig4 + plot_layout(widths = c(1, 3))
```

```{r}
DataSubValue <- as.numeric(names(table(DataSub$pair)[table(DataSub$pair) == 2]))
DataSub <- DataSub |>
  dplyr::filter(pair %in% DataSubValue) |>
  select(Type, SNR, pair, Location, FrequencyGroup, season) |>
  pivot_wider(names_from = Type,
              values_from = SNR)

test <-  t.test(DataSub$`Horizontal Antenna` -
                DataSub$`Magnetic Loop Antenna`)
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "20m band"] -
                DataSub$`Magnetic Loop Antenna`[DataSub$FrequencyGroup == "20m band"])
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "20m band" & DataSub$season == "Summer"] -
                DataSub$`Magnetic Loop Antenna`[DataSub$FrequencyGroup == "20m band" & DataSub$season == "Summer"])
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "40m band" & DataSub$season == "Summer"] -
                DataSub$`Magnetic Loop Antenna`[DataSub$FrequencyGroup == "40m band" & DataSub$season == "Summer"])
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "40m band"] -
                DataSub$`Magnetic Loop Antenna`[DataSub$FrequencyGroup == "40m band"])
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "40m band" & DataSub$season == "Winter"] -
                DataSub$`Magnetic Loop Antenna`[DataSub$FrequencyGroup == "40m band" & DataSub$season == "Winter"])
print(test)
```

```{r fig.height=4, fig.width=6}
DataSub <- DataSub |>
  mutate(Diff = `Horizontal Antenna` - `Magnetic Loop Antenna`)

for (s in unique(DataSub$FrequencyGroup)) {
  for (o in unique(DataSub$Location)) {
    print(s)
    print(o)
    print(t.test(DataSub$Diff[DataSub$FrequencyGroup == s & DataSub$Location == o]))
  }
}

DataSub <- DataSub |>
  drop_na() |>
  group_by(Location, FrequencyGroup) |>
  summarise(DiffMean = mean(Diff),
            DiffQ1 = quantile(Diff, 0.25),
            DiffQ2 = quantile(Diff, 0.5),
            DiffQ3 = quantile(Diff, 0.75),
            .groups = "drop")

ggplot(DataSub, aes(x = Location, y = DiffMean, color = FrequencyGroup)) +
  geom_point(shape = 3, position = position_dodge(0.9)) +
  geom_point(aes(y = DiffQ2), position = position_dodge(0.9)) +
  geom_errorbar(aes(ymin = DiffQ1, ymax = DiffQ3), width = 0.2, position = position_dodge(0.9))+
  theme_classic()+
  theme(legend.position = "right") +
  labs(x = "", y = "Difference of SNR", color = "Frequency Groups")
```

### Horizontal Antenna and Horizontal Antenna (QRO)

```{r fig.height=6, fig.width=8}
DataSub <- DataClean |>
  arrange(ID, Time) |>
  dplyr::filter(Type %in% c("Horizontal Antenna", "Horizontal Antenna (QRO)"))

DataSub$pair <- NA

time_window <- 2

pair_counter <- 1
for (i in 2:nrow(DataSub)) {
  ## Same ID, Samilar time and varied type
  if (DataSub$ID[i] == DataSub$ID[i - 1] &&
      difftime(DataSub$Time[i], DataSub$Time[i - 1], units = "hours") <= time_window &&
      DataSub$Type[i] != DataSub$Type[i - 1]) {
    DataSub$pair[i] <- pair_counter
    DataSub$pair[i - 1] <- pair_counter
    pair_counter <- pair_counter + 1
  }
}

fig1 <- ggboxplot(data = DataSub[DataSub$FrequencyGroup == "20m band",],
                 x = "Type",
                 y = "SNR",
                 color = "Type",
                 palette = 'Viridis',
                 add = 'jitter',
                 ggtheme = theme_bw(),
                 legend='none',
                 xlab = "",
                 ylab = 'SNR',
                 title = 'A') +
  stat_pvalue_manual(stat.test.higher[1,],
                     label = "p",
                     tip.length = 0.01)+
  scale_x_discrete(breaks = NULL)
fig2 <- ggboxplot(data = DataSub[DataSub$FrequencyGroup == "40m band",],
                 x = "Type",
                 y = "SNR",
                 color = "Type",
                 palette = 'Viridis',
                 add = 'jitter',
                 ggtheme = theme_bw(),
                 legend='none',
                 xlab = "",
                 ylab = 'SNR',
                 title = 'B') +
  stat_pvalue_manual(stat.test.lower[1,],
                     label = "p",
                     tip.length = 0.01)+
  scale_x_discrete(breaks = NULL)
fig3 <- ggplot(dplyr::filter(DataClean,
                             Type %in% c("Horizontal Antenna", "Horizontal Antenna (QRO)") &
                               FrequencyGroup == "20m band"),
               mapping = aes(x = hour, y = SNR)) +
  geom_smooth(mapping = aes(color = Type), size = 1)+
  scale_x_continuous(limits = c(6, 22))+
  facet_grid(season ~ ., scales = "free_x") +
  theme_bw() +
  theme(legend.position = 'right') +
  labs(x = "Hour", y = "SNR", color = "Type", title = "C")
fig4 <- ggplot(dplyr::filter(DataClean,
                             Type %in% c("Horizontal Antenna", "Horizontal Antenna (QRO)") &
                               FrequencyGroup == "40m band"),
               mapping = aes(x = hour, y = SNR)) +
  geom_smooth(mapping = aes(color = Type), size = 1)+
  scale_x_continuous(limits = c(6, 22))+
  facet_grid(season ~ ., scales = "free_x") +
  theme_bw() +
  theme(legend.position = 'right') +
  labs(x = "Hour", y = "SNR", color = "Type", title = "D")

fig1 + fig3 + fig2 + fig4 + plot_layout(widths = c(1, 3))

```

```{r}
DataSubValue <- as.numeric(names(table(DataSub$pair)[table(DataSub$pair) == 2]))
DataSub <- DataSub |>
  dplyr::filter(pair %in% DataSubValue) |>
  select(Type, SNR, pair, season, Location, FrequencyGroup) |>
  pivot_wider(names_from = Type,
              values_from = SNR)

test <-  t.test(DataSub$`Horizontal Antenna` -
                DataSub$`Horizontal Antenna (QRO)`)
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "20m band"] -
                DataSub$`Horizontal Antenna (QRO)`[DataSub$FrequencyGroup == "20m band"])
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "20m band" & DataSub$season == "Summer"] -
                DataSub$`Horizontal Antenna (QRO)`[DataSub$FrequencyGroup == "20m band" & DataSub$season == "Summer"])
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "40m band" & DataSub$season == "Summer"] -
                DataSub$`Horizontal Antenna (QRO)`[DataSub$FrequencyGroup == "40m band" & DataSub$season == "Summer"])
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "40m band"] -
                DataSub$`Horizontal Antenna (QRO)`[DataSub$FrequencyGroup == "40m band"])
print(test)

test <-  t.test(DataSub$`Horizontal Antenna`[DataSub$FrequencyGroup == "40m band" & DataSub$season == "Winter"] -
                DataSub$`Horizontal Antenna (QRO)`[DataSub$FrequencyGroup == "40m band" & DataSub$season == "Winter"])
print(test)
```

```{r fig.height=4, fig.width=6}
DataSub <- DataSub |>
  mutate(Diff = `Horizontal Antenna (QRO)` - `Horizontal Antenna`)

for (s in unique(DataSub$FrequencyGroup)) {
  for (o in unique(DataSub$Location)) {
    print(s)
    print(o)
    print(t.test(DataSub$Diff[DataSub$FrequencyGroup == s & DataSub$Location == o]))
  }
}

DataSub <- DataSub |>
  drop_na() |>
  group_by(Location, FrequencyGroup) |>
  summarise(DiffMean = mean(Diff),
            DiffQ1 = quantile(Diff, 0.25),
            DiffQ2 = quantile(Diff, 0.5),
            DiffQ3 = quantile(Diff, 0.75),
            n = n(),
            .groups = "drop")

ggplot(DataSub, aes(x = Location, y = DiffMean, color = FrequencyGroup)) +
  geom_point(shape = 3, position = position_dodge(0.9)) +
  geom_point(aes(y = DiffQ2), position = position_dodge(0.9)) +
  geom_errorbar(aes(ymin = DiffQ1, ymax = DiffQ3), width = 0.2, position = position_dodge(0.9))+
  theme_classic()+
  theme(legend.position = "right") +
  labs(x = "", y = "Difference of SNR", color = "Frequency Groups")
```

```{r fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
library(truncnorm)

# function ----------------------------------------------------------------

### negative log likelihood

nllt <- function(params, data) {
  mean <- params[1]
  sd <- params[2]
  alpha <- params[3]
  -sum(log(dtruncnorm(data[data >= alpha], a = alpha, mean = mean, sd = sd)))
  # -sum(log(dnorm(data[data >= alpha], mean = mean, sd = sd)))
}
nll <- function(params, data) {
  mean <- params[1]
  sd <- params[2]
  -sum(log(dnorm(data, mean = mean, sd = sd)))
}

Datalist <- DataClean |>
  dplyr::filter(TypeMag == 0) |>
  select(FrequencyGroup, Type) |>
  unique() |>
  arrange(FrequencyGroup, Type)
i <- 1

for (i in c(1, 3)) {
  Data <- DataClean |>
    dplyr::filter(FrequencyGroup == Datalist$FrequencyGroup[i] & Type == Datalist$Type[i])
  data <- Data$SNR

  ## All data
  fit <- optim(
    par = c(mean(data), sd(data)),
    nll,
    data = data,
    method = "L-BFGS-B",
    lower = c(-Inf, 0),
    upper = c(Inf, Inf)
  )

  ## All data gamma distribution
  fit2 <- MASS::fitdistr(data, "gamma")

  ## Partly data
  fit1 <- optim(
    par = c(mean(data), sd(data), 0),
    nllt,
    data = data,
    method = "L-BFGS-B",
    lower = c(-Inf, 0, 0),
    upper = c(Inf, Inf, 3)
  )

  ## plot
  outcome <- ks.test(data,
    "pnorm",
    mean = fit$par[1],
    sd = fit$par[2]
  )
  outcome1 <- ks.test(data[data >= fit1$par[3]],
    "pnorm",
    mean = fit1$par[1],
    sd = fit1$par[2]
  )
  outcome2 <- ks.test(data,
    "pgamma",
    shape = fit2$estimate[1],
    rate = fit2$estimate[2]
  )
  print(outcome)
  print(outcome1)
  print(outcome2)

  fig <- ggplot(
    data = Data,
    mapping = aes(x = SNR)
  ) +
    geom_histogram(
      mapping = aes(y = after_stat(density)),
      alpha = 0.75
    ) +
    geom_line(
      stat = "density",
      mapping = aes(color = "Density Curve")
    ) +
    stat_function(
      fun = dnorm,
      args = list(
        mean = fit$par[1],
        sd = fit$par[2]
      ),
      mapping = aes(color = "Fitted Curve (Normal)")
    ) +
    stat_function(
      fun = dgamma,
      args = list(
        shape = fit2$estimate[1],
        rate = fit2$estimate[2]
      ),
      mapping = aes(color = "Fitted Curve (Gamma)")
    ) +
    stat_function(
      fun = dtruncnorm,
      args = list(
        mean = fit1$par[1],
        sd = fit1$par[2],
        a = fit1$par[3]
      ),
      mapping = aes(color = "Fitted Curve (Truncated Normal)")
    ) +
    scale_y_continuous(
      limits = c(0, NA),
      expand = expansion(mult = c(0, 0.1))
    ) +
    theme_bw() +
    theme(
      plot.caption = element_text(hjust = 0),
      legend.position = c(0.95, 0.95),
      legend.justification = c(1, 1)
    ) +
    labs(
      color = NULL,
      caption = paste("Fitted Distribution\n",
        "Normal Distribution: (", round(fit$par[1], 3), ",", round(fit$par[2], 3), ")\n",
        "Truncated Normal Distribution: (", round(fit1$par[1], 3), ",", round(fit1$par[2], 3), ")\n",
        "Gamma Distribution: (", round(fit2$estimate[1], 3), ",", round(fit2$estimate[2], 3), ")\n",
        "Log-likelihood\n",
        "Normal Distribution: ", round(fit$value), "\n",
        "Gamma Distribution: ", -round(fit2$loglik), "\n",
        "Truncated Normal Distribution: ", round(fit1$value), "\n",
        "Kolmogorov-Smirnov\n",
        "Normal Distribution: ", round(outcome$statistic, 3),
        "; P-value=", round(outcome$p.value, 3), "\n",
        "Gamma Distribution: ", round(outcome2$statistic, 3),
        "; P-value=", round(outcome2$p.value, 3), "\n",
        "Truncated Normal Distribution: ", round(outcome1$statistic, 3),
        "; P-value=", round(outcome1$p.value, 3),
        sep = ""
      ),
      title = paste(LETTERS[i], ":", Datalist$Type[i], "in", Datalist$FrequencyGroup[i])
    )

  assign(
    paste0("fig", i),
    fig
  )
  remove(fig, data, Data, fit, fit1, outcome, outcome1)
}

for (i in c(2, 4)) {
  Data <- DataClean |>
    dplyr::filter(FrequencyGroup == Datalist$FrequencyGroup[i] & Type == Datalist$Type[i])
  data <- Data$SNR

  ## All data
  fit <- optim(
    par = c(mean(data), sd(data)),
    nll,
    data = data,
    method = "L-BFGS-B",
    lower = c(-Inf, 0),
    upper = c(Inf, Inf)
  )
  ## Alll data gamma distribution
  fit2 <- MASS::fitdistr(data, "gamma")

  ## plot
  outcome <- ks.test(data,
    "pnorm",
    mean = fit$par[1],
    sd = fit$par[2]
  )
  outcome2 <- ks.test(data,
    "pgamma",
    shape = fit2$estimate[1],
    rate = fit2$estimate[2]
  )
  print(outcome)
  print(outcome2)

  fig <- ggplot(
    data = Data,
    mapping = aes(x = SNR)
  ) +
    geom_histogram(
      mapping = aes(y = after_stat(density)),
      alpha = 0.75
    ) +
    geom_line(
      stat = "density",
      mapping = aes(color = "Density Curve")
    ) +
    stat_function(
      fun = dnorm,
      args = list(
        mean = fit$par[1],
        sd = fit$par[2]
      ),
      mapping = aes(color = "Fitted Curve (Normal)")
    ) +
    stat_function(
      fun = dgamma,
      args = list(
        shape = fit2$estimate[1],
        rate = fit2$estimate[2]
      ),
      mapping = aes(color = "Fitted Curve (Gamma)")
    ) +
    scale_y_continuous(
      limits = c(0, NA),
      expand = expansion(mult = c(0, 0.1))
    ) +
    theme_bw() +
    theme(
      plot.caption = element_text(hjust = 0),
      legend.position = c(0.95, 0.95),
      legend.justification = c(1, 1)
    ) +
    labs(
      color = NULL,
      caption = paste("Fitted Distribution\n",
        "Normal Distribution: (", round(fit$par[1], 3), ",", round(fit$par[2], 3), ")\n",
        "Gamma Distribution: (", round(fit2$estimate[1], 3), ",", round(fit2$estimate[2], 3), ")\n",
        "Log-likelihood\n",
        "Normal Distribution: ", round(fit$value), "\n",
        "Gamma Distribution: ", -round(fit2$loglik), "\n",
        "Kolmogorov-Smirnov\n",
        "Normal Distribution: ", round(outcome$statistic, 3),
        "; P-value=", round(outcome$p.value, 3), "\n",
        "Gamma Distribution: ", round(outcome2$statistic, 3),
        "; P-value=", round(outcome2$p.value, 3),
        sep = ""
      ),
      title = paste(LETTERS[i], ":", Datalist$Type[i], "in", Datalist$FrequencyGroup[i])
    )

  assign(
    paste0("fig", i),
    fig
  )
  remove(fig, data, Data, fit, fit1, outcome, outcome1)
}

fig1 + fig2 + fig3 + fig4


ggsave("./Distribution_p.png",
  width = 10,
  height = 10
)

```

## Adjusted by station

Mixed Design ANOVA

Consider the samples not independent, because some samples collect from the same station.

```{r}
model <- aov(SNR ~ Type + Error(ID), data = DataClean)
summary(model)
```

The difference between groups was still statistically significant, after adjusted by station.

Multiple linear regression (Quantitative difference)

```{r}
model <- lm(SNR ~ TypeQro + TypeMag + ID,
            data = DataClean)
summary(model)
```

horizontal qro: 3.71024

magloop: (negative) -1.58319

not independent

```{r message=FALSE, warning=FALSE}
library(lme4)
library(car)
model <- lmer(SNR ~ TypeQro + (1 | ID), data = dplyr::filter(DataClean, TypeMag == 0))
summary(model)
Anova(model)

model <- lmer(SNR ~ TypeMag + (1 | ID), data = dplyr::filter(DataClean, TypeQro == 0))
summary(model)
Anova(model)
```

horizontal qro: 3.3105

magloop: (negative) -1.3734

## Adjusted by station and periods

```{r}
model <- lmer(SNR ~ TypeQro + (1 | ID) + (1 | periods), data = dplyr::filter(DataClean, TypeMag == 0))
summary(model)
Anova(model)

model <- lmer(SNR ~ TypeMag + (1 | ID) + (1 | periods), data = dplyr::filter(DataClean, TypeQro == 0))
summary(model)
Anova(model)
```

## Adjusted by distance and direction

```{r}
model <- lmer(SNR ~ TypeQro + (1 | Distance) + (1 | Location),
              data = dplyr::filter(DataClean, TypeMag == 0 & FrequencyGroup == "20m band"))
summary(model)
Anova(model)

model <- lmer(SNR ~ TypeQro + (1 | Distance) + (1 | Location),
              data = dplyr::filter(DataClean, TypeMag == 0 & FrequencyGroup == "40m band"))
summary(model)
Anova(model)

model <- lmer(SNR ~ TypeMag + (1 | Distance) + (1 | Location),
              data = dplyr::filter(DataClean, TypeQro == 0 & FrequencyGroup == "20m band"))
summary(model)
Anova(model)

model <- lmer(SNR ~ TypeMag + (1 | Distance) + (1 | Location),
              data = dplyr::filter(DataClean, TypeQro == 0 & FrequencyGroup == "40m band"))
summary(model)
Anova(model)
```

```{r}
model <- lmer(SNR ~ TypeQro + (1 | DistanceGroup) + (1 | periods) + (1 | Location), data = dplyr::filter(DataClean, TypeMag == 0))
summary(model)
Anova(model)

model <- lmer(SNR ~ TypeMag + (1 | DistanceGroup) + (1 | periods) + (1 | Location), data = dplyr::filter(DataClean, TypeQro == 0))
summary(model)
Anova(model)
```

## Design model to predict SNR

```{r message=FALSE, warning=FALSE}
DataClean <- DataClean |>
  mutate(DistanceGroup = cut(Distance,
                             breaks = c(0, 500, 1000, 1300, 3000, 10000)))
for (s in unique(DataClean$season)) {
  for (d in unique(DataClean$DistanceGroup)) {
    DataSub <- DataClean |>
      filter(season == s & DistanceGroup == d)
    model <- lmer(SNR ~ TypeQro + TypeMag + as.factor(hour) + (1|ID), data = DataClean)
    print(paste(s, d))
    print(summary(model))
  }
}
```
